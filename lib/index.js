!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("StorageDB",[],t):"object"==typeof exports?exports.StorageDB=t():e.StorageDB=t()}(self,(function(){return(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/
e.r(t),e.d(t,{default:()=>f});const r=["$eq","$gt","$gte","$in","$lt","$lte","$ne","$nin"],i=e=>"number"!=typeof e,s={$eq:(e,t)=>t===e,$gt:(e,t)=>{if(i(e))throw new Error("'$gt' value must be a number");return t>e},$gte:(e,t)=>{if(i(e))throw new Error("'$gte' value must be a number");return t>=e},$in:(e,t)=>{if(!(e instanceof Array))throw new Error("'$in' value must be an array");return e.includes(t)},$lt:(e,t)=>{if(i(e))throw new Error("'$lt' value must be a number");return t<e},$lte:(e,t)=>{if(i(e))throw new Error("'$lte' value must be a number");return t<=e},$ne:(e,t)=>t!==e,$nin:(e,t)=>{if(!(e instanceof Array))throw new Error("'$nin' value must be an array");return!e.includes(t)},_checkExist:e=>{if(r.includes(e))return!0;throw new Error("unknown operator: '"+e+"'")}},a=(e,t)=>{var r,i,s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),a=[];if(t=t||s.length,e)for(r=0;r<e;r++)a[r]=s[0|Math.random()*t];else for(a[8]=a[13]=a[18]=a[23]="-",a[14]="4",r=0;r<36;r++)a[r]||(i=0|16*Math.random(),a[r]=s[19==r?3&i|8:i]);return a.join("")},n=e=>e instanceof Object&&"Object"===e.constructor.name,l=e=>e instanceof Array&&"Array"===e.constructor.name,o=(e,t)=>{if(!e||!Object.keys(e).length)return!0;for(let r of Object.keys(e)){let i=e[r],a=t[r];if(i instanceof RegExp){if(!i.test(a))return!1}else if(n(i)){for(let e of Object.keys(i))if(s._checkExist(e)&&!s[e](i[e],a))return!1}else if(i!==a)return!1}return!0},h=(e,t,r,i,s)=>{i=i||0;let a=(s=s||Object.keys(e))[i];return a?t[a]===r[a]?(i++,h(e,t,r,i,s)):1===e[a]?t[a]-r[a]:-1===e[a]?r[a]-t[a]:void 0:0};class u{constructor(e,t,r){r=r||{},this.name=t,this.storage=e.storage,this.path=e.database+e.sep+t,this.primaryKey=r.primaryKey||e.primaryKey,this.cache=[],this.cacheable=!1}_initCache(){let e=[],t=new RegExp("^"+this.path);for(let r of Object.keys(this.storage))t.test(r)&&(e=JSON.parse(this.storage.getItem(r)));this.cache=e,this.cacheable=!0}_filter(e,t){t.type=t.type||"data",t.multi=t.multi||!1,this.cacheable||this._initCache();let r,i=[],s="id"===t.type;if("string"==typeof e)e=new RegExp(e);else if("function"==typeof e)r=!0;else if(!e){let e=s?Object.keys(this.cache):Object.values(this.cache);return t.multi?e:e[0]||null}for(let a of Object.keys(this.cache)){let n=this.cache[Number(a)];if(r){if(e(a,n)){let e=s?a:n;if(!t.multi)return e;i.push(e)}}else if(e.test(n[this.primaryKey])){let e=s?a:n;if(!t.multi)return e;i.push(e)}}return t.multi?i:null}inset(e,t){var r;let i=l(e),s=n(e);if(i){if(0===e.length)return[]}else e=[e];let o=this.primaryKey,h=this.cacheable,u=JSON.parse(this.storage.getItem(this.path)||"[]");for(let t of e){if(!s&&!i)throw new Error("TypeError: insert data must be an object or an object array");void 0!==t[o]&&0!==(null===(r=t[o])||void 0===r?void 0:r.length)||(t[o]=a()),t.createdTime||(t.createdTime=new Date,t.updatedTime=""),h&&(this.cache=u.concat(t)),this.storage.setItem(this.path,JSON.stringify(u.concat(t)))}return i?e:e[0]}find(e,t){let r;e=e||{},(t=t||{}).skip=t.skip||0,t.limit=t.limit,t.sort=t.sort,l(t.sort)&&(t.sort=t.sort.reduce(((e,t)=>("string"==typeof t?e[t]=1:t instanceof Array&&t.length&&(e[t[0]]=t[1]||1),e)),{}));let i=n(e)?null:l(e)?e:[e],s={type:t._filterType||"data",multi:!0};if(i){let e=new RegExp("^"+i.join("|")+"$");r=this._filter(e,s)}else r=Object.keys(e).length?this._filter(((t,r)=>o(e,r)),s):this._filter(null,s);return t.sort&&r.sort(((e,r)=>h(null==t?void 0:t.sort,e,r))),t.limit?r=r.slice(t.skip,t.skip+t.limit):t.skip&&(r=r.slice(t.skip)),r}findOne(e,t){let r;t=t||{};let i=n(e=e||{})?null:e,s=e?Object.keys(e):[],a=!1,l=!!t.sort,h={type:t._filterType||"data",multi:!1};if(s.length&&s.includes(this.primaryKey)&&(i=e[this.primaryKey],a=!0),i){if(r=this.storage.getItem(this.path),r=r?JSON.parse(r):null,r&&a&&!o(e,r))return null;r=r?r.find((e=>e[this.primaryKey]===i)):void 0}else r=s.length?l?this.find(e,t):this._filter(((t,r)=>o(e,r)),h):l?this.find(e,t):this._filter(null,h);return!i&&l&&r&&(r=r[0]||null),r}remove(e,t){if(!e)throw new Error("remove needs a query");(t=t||{}).multi=void 0===t.multi||t.multi;let r=JSON.parse(this.storage.getItem(this.path)),i=t.multi?this.find(e,{_filterType:"data"}):this.findOne(e,{_filterType:"data"}),s=this.cacheable;if(t.mulit&&!i.length||!t.mulit&&!i)return 0;t.multi||(i=[i]);for(let e of i)s&&(this.cache=this.cache.filter((t=>t[this.primaryKey]!==e[this.primaryKey]))),r=r.filter((t=>t[this.primaryKey]!==e[this.primaryKey])),this.storage.setItem(this.path,JSON.stringify(r));return i.length}update(e,t,r){if(!e)throw new Error("update needs a query");if(!t||!n(t))throw new Error("update needs an object");(r=r||{}).multi=void 0!==r.multi&&r.multi;let i=this.primaryKey,s=this.cacheable;t[i]&&delete t[i];let a=r.multi?this.find(e,{_filterType:(null==r?void 0:r._filterType)||"data"}):this.findOne(e,{_filterType:(null==r?void 0:r._filterType)||"data"});if(r.mulit&&!a.length||!r.mulit&&!a)return 0;if(r.multi){delete t[i];let e=a,r=JSON.parse(this.storage.getItem(this.path));return r?(r=r.map((r=>(e.forEach((e=>{if(r[i]===e[i])for(let e in t)r[e]=t[e],r.updatedTime=new Date})),r))),s&&(this.cache=r),this.storage.setItem(this.path,JSON.stringify(r)),a.length):null}{let e=a,r=JSON.parse(this.storage.getItem(this.path));return r?(r=r.map((r=>{if(r[i]===e[i])for(let e in t)r[e]=t[e],r.updatedTime=new Date;return r})),this.storage.setItem(this.path,JSON.stringify(r)),s&&(this.cache=r),r):null}}drop(){return this.remove({}),!0}count(){let e=this.storage.getItem(this.path);return e?JSON.parse(e).length:void 0}}const f=class{constructor(e){this.storage=e.storage||window&&window.localStorage,this.database=e.database||"db",this.primaryKey=e.primaryKey||"_id",this.sep=e.sep||":",(e=>{if(!(e&&e instanceof Object))return!1;try{return e.setItem("_supported","1"),e.removeItem("_supported"),!0}catch(e){return!1}})(this.storage)||(this.storage=null)}get(e,t){return new u(this,e,t||{storage:this.storage,database:this.database,primaryKey:this.primaryKey,sep:this.sep})}collection(e,t){return this.get(e,t)}size(){let e=0;for(let t in this.storage)if(this.storage.hasOwnProperty(t)&&-1!==t.indexOf(this.database+":")){const r=this.storage.getItem(t);e+=r?r.length:0}return e}};return t=t.default})()}));